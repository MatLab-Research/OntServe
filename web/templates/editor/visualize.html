<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - OntServe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Cytoscape core -->
    <script src="https://unpkg.com/cytoscape@3.21.0/dist/cytoscape.min.js"></script>
    
    <!-- Only load dagre for hierarchical layout -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>
    <style>
        .visualization-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            min-height: 600px;
        }

        .entity-details-card {
            position: sticky;
            top: 20px;
        }

        /* Cytoscape container styles */
        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #fafafa;
        }

        .cy-node-selected {
            border-width: 3px !important;
            border-color: #ff6b6b !important;
        }

        .cy-edge-selected {
            line-color: #ff6b6b !important;
            target-arrow-color: #ff6b6b !important;
            width: 4px !important;
        }

        /* Layout control styles */
        .layout-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .layout-btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 12px;
        }

        .layout-btn.active {
            background-color: #007bff;
            color: white;
        }

        /* Minimap styles */
        .cy-navigator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 200px;
            height: 150px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Entity type specific colors */
        .entity-class {
            color: #4A90E2;
        }

        .entity-property {
            color: #F5A623;
        }

        .entity-individual {
            color: #7ED321;
        }

        .entity-role {
            color: #9013FE;
        }

        .entity-condition {
            color: #FF6B6B;
        }

        .entity-resource {
            color: #4ECDC4;
        }

        .entity-action {
            color: #FFD93D;
        }

        .entity-event {
            color: #FF9500;
        }

        .entity-capability {
            color: #00C9FF;
        }

        .entity-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .entity-uri {
            font-size: 0.8em;
            color: #6c757d;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        .entity-property {
            margin-bottom: 0.75rem;
        }

        .entity-property-name {
            font-weight: bold;
            color: #495057;
        }

        .entity-property-value {
            margin-top: 0.25rem;
            color: #6c757d;
        }

        .toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }

        .controls-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .semantic-search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .similarity-score {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Additional Cytoscape styling for highlighting */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            max-width: 300px;
            z-index: 100;
            font-size: 13px;
            display: none;
        }

        /* Highlighting styles */
        .cy-node.highlighted {
            border-width: 4px !important;
            border-color: #ff6b6b !important;
        }

        .cy-node.connected {
            border-width: 3px !important;
            border-color: #4CAF50 !important;
        }

        .cy-node.dimmed {
            opacity: 0.3 !important;
        }

        .cy-edge.highlighted {
            line-color: #ff6b6b !important;
            target-arrow-color: #ff6b6b !important;
            width: 4px !important;
        }

        .cy-edge.dimmed {
            opacity: 0.2 !important;
        }

        .cy-node.search-match {
            border-width: 4px !important;
            border-color: #FFD700 !important;
            background-color: #FFEB3B !important;
        }

        .cy-node.search-highlight {
            border-width: 5px !important;
            border-color: #FF5722 !important;
            background-color: #FF8A65 !important;
        }

        .cy-node.highlight-restrictions {
            border-color: #F5A623 !important;
            border-width: 4px !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/editor">
                <i class="fas fa-project-diagram me-2"></i>
                OntServe Editor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/editor">
                    <i class="fas fa-arrow-left me-1"></i>Back to Editor
                </a>
            </div>
        </div>
    </nav>

    <div class="toolbar">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-project-diagram me-2"></i>
                        {{ ontology.name }}
                    </h1>
                    <small class="text-muted">Ontology Visualization with Semantic Search</small>
                </div>
                <div class="col-md-4">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="fitToScreen()">
                            <i class="fas fa-expand-arrows-alt me-1"></i>Fit Screen
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="resetZoom()">
                            <i class="fas fa-search-minus me-1"></i>Reset Zoom
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportVisualization()">
                            <i class="fas fa-download me-1"></i>Export PNG
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Controls Panel -->
            <div class="col-md-3">
                <div class="controls-panel">
                    <h6><i class="fas fa-filter me-2"></i>Visualization Controls</h6>

                    <div class="mb-3">
                        <label class="form-label">Layout Algorithm</label>
                        <select class="form-select form-select-sm" id="layoutSelector">
                            <option value="dagre" selected>Hierarchical (Dagre)</option>
                            <option value="breadthfirst">Breadth First</option>
                            <option value="cose">Force Directed (COSE)</option>
                            <option value="circle">Circular</option>
                            <option value="grid">Grid</option>
                            <option value="concentric">Concentric</option>
                        </select>
                        <button class="btn btn-primary btn-sm mt-2 w-100" onclick="applyLayout()">
                            <i class="fas fa-project-diagram me-1"></i>Apply Layout
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Entity Type Filter</label>
                        <select class="form-select form-select-sm" id="filterType">
                            <option value="all">All Types</option>
                            <option value="class" selected>Classes Only</option>
                            <option value="property">Properties Only</option>
                            <option value="individual">Individuals Only</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Search Entities</label>
                        <input type="text" class="form-control form-control-sm" id="searchBox"
                            placeholder="Enter search term...">
                        <button class="btn btn-primary btn-sm mt-2 w-100" onclick="performSemanticSearch()">
                            <i class="fas fa-search me-1"></i>Search & Highlight
                        </button>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showInferred" checked>
                        <label class="form-check-label" for="showInferred">
                            Show Inferred Relations
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showRestrictions">
                        <label class="form-check-label" for="showRestrictions">
                            Show Restrictions
                        </label>
                    </div>

                    <button class="btn btn-outline-primary btn-sm w-100" onclick="applyFilters()">
                        <i class="fas fa-filter me-1"></i>Apply Filters
                    </button>
                </div>

                <!-- Semantic Search Results -->
                <div class="controls-panel" id="searchResultsPanel" style="display: none;">
                    <h6><i class="fas fa-search me-2"></i>Search Results</h6>
                    <div id="searchResults" class="semantic-search-results">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <!-- Statistics Panel -->
                <div class="controls-panel">
                    <h6><i class="fas fa-chart-bar me-2"></i>Statistics</h6>
                    <div id="hierarchyStats">
                        <div class="d-flex justify-content-between">
                            <small>Total Nodes:</small>
                            <strong id="totalNodes">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>Total Edges:</small>
                            <strong id="totalEdges">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>Classes:</small>
                            <strong id="classCount">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>Properties:</small>
                            <strong id="propertyCount">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>Inferred:</small>
                            <strong id="inferredCount">-</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>Consistent:</small>
                            <strong id="consistencyStatus">-</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization Area -->
            <div class="col-md-6">
                <div class="visualization-container" style="position: relative;">
                    <div id="loadingIndicator" class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading ontology visualization...</div>
                        </div>
                    </div>
                    <div id="cy" style="display: none;"></div>

                    <!-- Layout Controls Overlay -->
                    <div class="layout-controls">
                        <div class="btn-group-vertical">
                            <button class="btn btn-sm btn-outline-secondary layout-btn" onclick="zoomIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary layout-btn" onclick="zoomOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary layout-btn" onclick="fitToScreen()">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary layout-btn" onclick="centerGraph()">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entity Details Panel -->
            <div class="col-md-3">
                <div class="card entity-details-card" id="entityDetailsCard" style="display: none;">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Entity Details
                        </h6>
                    </div>
                    <div class="card-body" id="entityDetails">
                        <!-- Entity details will be populated here -->
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-outline-primary w-100" id="findSimilarBtn"
                            onclick="findSimilarEntities()" style="display: none;">
                            <i class="fas fa-search me-1"></i>Find Similar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let cy; // Cytoscape instance
        let currentLayout = 'dagre';
        let ontologyData;
        let currentEntityData;
        let originalElements; // Store original elements for filtering
        const ontologyId = "{{ ontology_id }}";

        function triggerProcessing() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            fetch(`/editor/api/enhanced/process/${ontologyId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the visualization data
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Processing failed: ' + (data.error || 'Unknown error'));
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-cogs"></i> Process Ontology';
                }
            })
            .catch(error => {
                console.error('Processing error:', error);
                alert('Processing failed. Please check the console for details.');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-cogs"></i> Process Ontology';
            });
        }

        // Initialize visualization on load
        document.addEventListener('DOMContentLoaded', function () {
            setupEventListeners();
            initializeCytoscape();
            loadOntologyData();
        });

        function setupEventListeners() {
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('showInferred').addEventListener('change', applyFilters);
            document.getElementById('showRestrictions').addEventListener('change', applyFilters);
            document.getElementById('layoutSelector').addEventListener('change', function () {
                currentLayout = this.value;
            });

            document.getElementById('searchBox').addEventListener('keyup', function (e) {
                if (e.key === 'Enter') {
                    performSemanticSearch();
                }
            });
        }

        function initializeCytoscape() {
            // Register dagre layout extension
            try {
                if (typeof cytoscape !== 'undefined' && typeof cytoscapeDagre !== 'undefined') {
                    cytoscape.use(cytoscapeDagre);
                }
            } catch (e) {
                console.warn('Dagre layout extension failed to register:', e);
            }

            cy = cytoscape({
                container: document.getElementById('cy'),

                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#4A90E2',
                            'label': 'data(label)',
                            'width': 60,
                            'height': 60,
                            'color': '#333',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '10px',
                            'font-weight': 'bold',
                            'border-width': 2,
                            'border-color': '#fff',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px'
                        }
                    },
                    {
                        selector: 'node.inferred',
                        style: {
                            'background-color': '#7ED321',
                            'border-style': 'dashed',
                            'border-width': 3
                        }
                    },
                    {
                        selector: 'node.has-restrictions',
                        style: {
                            'border-color': '#F5A623',
                            'border-width': 3
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-color': '#ff6b6b',
                            'border-width': 4
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#999',
                            'target-arrow-color': '#999',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.2
                        }
                    },
                    {
                        selector: 'edge.inferred',
                        style: {
                            'line-color': '#7ED321',
                            'target-arrow-color': '#7ED321',
                            'line-style': 'dashed',
                            'width': 3
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'line-color': '#ff6b6b',
                            'target-arrow-color': '#ff6b6b',
                            'width': 4
                        }
                    },
                    // Namespace-based colors
                    {
                        selector: 'node.ns-bfo',
                        style: {
                            'background-color': '#8E24AA'
                        }
                    },
                    {
                        selector: 'node.ns-prov',
                        style: {
                            'background-color': '#F57F17'
                        }
                    },
                    {
                        selector: 'node.ns-proethica',
                        style: {
                            'background-color': '#D32F2F'
                        }
                    }
                ],

                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    animate: true,
                    animationDuration: 500
                },

                // Interaction options
                zoomingEnabled: true,
                userZoomingEnabled: true,
                panningEnabled: true,
                userPanningEnabled: true,
                boxSelectionEnabled: true,
                selectionType: 'single',

                // Performance
                textureOnViewport: false,
                motionBlur: true,
                wheelSensitivity: 0.2
            });

            // Event handlers
            cy.on('tap', 'node', function (evt) {
                const node = evt.target;
                showNodeDetails(node);
                highlightConnectedNodes(node);
            });

            cy.on('tap', function (evt) {
                if (evt.target === cy) {
                    // Clicked on background - clear selection
                    clearHighlights();
                    hideEntityDetails();
                }
            });

            cy.on('mouseover', 'node', function (evt) {
                const node = evt.target;
                showTooltip(evt, node);
            });

            cy.on('mouseout', 'node', function (evt) {
                hideTooltip();
            });
        }

        function loadOntologyData() {
            const entityType = document.getElementById('filterType').value;
            const includeReasoning = document.getElementById('reasoningToggle')?.checked || false;
            const url = `/editor/api/enhanced/visualization/${ontologyId}?include_reasoning=${includeReasoning}&limit=1000`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load ontology hierarchy');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.visualization) {
                        ontologyData = data;
                        // Enhanced visualization already provides cytoscape-ready format
                        const elements = [...data.visualization.nodes, ...data.visualization.edges];
                        originalElements = elements;
                        
                        if (elements.length === 0) {
                            // No entities to visualize
                            document.getElementById('loadingIndicator').innerHTML = `
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>No entities found for visualization</strong>
                                    <p class="mb-2">This ontology may need to be processed to extract entities.</p>
                                    <button class="btn btn-primary btn-sm" onclick="triggerProcessing()">
                                        <i class="fas fa-cogs"></i> Process Ontology
                                    </button>
                                </div>
                            `;
                        } else {
                            loadDataIntoGraph(elements);
                            updateStatistics(data.stats);
                            // Hide loading indicator and show graph
                            document.getElementById('loadingIndicator').style.display = 'none';
                            document.getElementById('cy').style.display = 'block';
                        }
                    } else {
                        throw new Error(data.error || 'No visualization data available');
                    }
                })
                .catch(error => {
                    console.error('Error loading ontology hierarchy:', error);
                    document.getElementById('loadingIndicator').innerHTML = `
                        <div class="alert alert-danger">
                            Error loading ontology hierarchy: ${error.message}
                        </div>
                    `;
                });
        }

        function convertHierarchyToCytoscape(hierarchy) {
            const elements = [];
            const processedNodes = new Set();

            function processNode(node, parentId = null) {
                if (!node || processedNodes.has(node.uri || node.name)) return;

                const nodeId = node.uri || node.name;
                processedNodes.add(nodeId);

                // Add node
                const nodeData = {
                    group: 'nodes',
                    data: {
                        id: nodeId,
                        label: node.label || node.name,
                        name: node.name,
                        uri: node.uri,
                        type: node.entity_type || node.type || 'class',
                        description: node.description || node.comment,
                        is_inferred: node.is_inferred || false,
                        restrictions: node.restrictions || 0,
                        namespace: getNamespaceFromURI(node.uri)
                    },
                    classes: getNodeClasses(node)
                };
                elements.push(nodeData);

                // Add edge to parent
                if (parentId && parentId !== nodeId) {
                    const edgeData = {
                        group: 'edges',
                        data: {
                            id: `${nodeId}_${parentId}`,
                            source: nodeId,
                            target: parentId,
                            type: 'subClassOf',
                            is_inferred: node.is_inferred || false
                        },
                        classes: node.is_inferred ? 'inferred' : 'explicit'
                    };
                    elements.push(edgeData);
                }

                // Process children
                if (node.children && Array.isArray(node.children)) {
                    node.children.forEach(child => processNode(child, nodeId));
                }
            }

            processNode(hierarchy);
            return elements;
        }

        function getNamespaceFromURI(uri) {
            if (!uri) return '';

            if (uri.includes('bfo')) return 'bfo';
            if (uri.includes('prov')) return 'prov';
            if (uri.includes('proethica')) return 'proethica';

            // Extract domain from URI
            const match = uri.match(/https?:\/\/([^\/]+)/);
            return match ? match[1].replace(/\./g, '-') : '';
        }

        function getNodeClasses(node) {
            const classes = ['class-node'];

            if (node.is_inferred) {
                classes.push('inferred');
            }

            if (node.restrictions && node.restrictions > 0) {
                classes.push('has-restrictions');
            }

            const namespace = getNamespaceFromURI(node.uri);
            if (namespace) {
                classes.push(`ns-${namespace}`);
            }

            return classes.join(' ');
        }

        function loadDataIntoGraph(elements) {
            // Clear existing elements
            cy.elements().remove();

            // Add new elements
            cy.add(elements);

            // Apply initial layout
            applyLayout();
        }

        function applyLayout() {
            const layoutName = currentLayout;
            const nodeCount = cy.nodes().length;

            let layoutConfig = { name: layoutName, animate: true, animationDuration: 1000 };

            // Configure layout based on type and size
            switch (layoutName) {
                case 'dagre':
                    layoutConfig = {
                        ...layoutConfig,
                        rankDir: 'TB',
                        spacingFactor: 1.2,
                        nodeSep: 50,
                        edgeSep: 10,
                        rankSep: 100
                    };
                    break;

                case 'cose':
                    layoutConfig = {
                        ...layoutConfig,
                        nodeRepulsion: nodeCount < 100 ? 400000 : 800000,
                        nodeOverlap: 20,
                        idealEdgeLength: 80,
                        edgeElasticity: 200
                    };
                    break;

                case 'breadthfirst':
                    layoutConfig = {
                        ...layoutConfig,
                        directed: true,
                        spacingFactor: 1.5
                    };
                    break;

                case 'circle':
                    layoutConfig = {
                        ...layoutConfig,
                        radius: Math.min(300, nodeCount * 10),
                        spacingFactor: 1.2
                    };
                    break;

                case 'grid':
                    layoutConfig = {
                        ...layoutConfig,
                        rows: Math.ceil(Math.sqrt(nodeCount)),
                        spacingFactor: 1.2
                    };
                    break;
                    
                case 'concentric':
                    layoutConfig = {
                        ...layoutConfig,
                        minNodeSpacing: 50,
                        spacingFactor: 1.5
                    };
                    break;
            }

            const layout = cy.layout(layoutConfig);
            layout.run();
        }

        // New Cytoscape-based functions
        function showNodeDetails(node) {
            const nodeData = node.data();
            currentEntityData = nodeData;

            const detailsElement = document.getElementById('entityDetails');
            const detailsCard = document.getElementById('entityDetailsCard');
            const findSimilarBtn = document.getElementById('findSimilarBtn');

            let html = `<div class="entity-header">${nodeData.label || nodeData.name}</div>`;

            if (nodeData.uri) {
                html += `<div class="entity-uri">${nodeData.uri}</div>`;
            }

            if (nodeData.description) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Description:</span>
                        <div class="entity-property-value">${nodeData.description}</div>
                    </div>
                `;
            }

            if (nodeData.type) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Type:</span>
                        <div class="entity-property-value">
                            <span class="badge bg-secondary entity-${nodeData.type}">
                                ${nodeData.type}
                            </span>
                        </div>
                    </div>
                `;
            }

            if (nodeData.is_inferred) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Inferred:</span>
                        <div class="entity-property-value">
                            <span class="badge bg-success">Yes</span>
                        </div>
                    </div>
                `;
            }

            if (nodeData.restrictions > 0) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Restrictions:</span>
                        <div class="entity-property-value">${nodeData.restrictions}</div>
                    </div>
                `;
            }

            // Show connections
            const connectedEdges = node.connectedEdges();
            const parents = connectedEdges.filter(edge => edge.target().id() === node.id()).sources();
            const children = connectedEdges.filter(edge => edge.source().id() === node.id()).targets();

            if (parents.length > 0) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Parents:</span>
                        <div class="entity-property-value">
                            ${parents.map(p => `<small class="d-block">${p.data('label')}</small>`).join('')}
                        </div>
                    </div>
                `;
            }

            if (children.length > 0) {
                html += `
                    <div class="entity-property">
                        <span class="entity-property-name">Children:</span>
                        <div class="entity-property-value">
                            ${children.map(c => `<small class="d-block">${c.data('label')}</small>`).join('')}
                        </div>
                    </div>
                `;
            }

            detailsElement.innerHTML = html;
            detailsCard.style.display = 'block';
            findSimilarBtn.style.display = nodeData.uri ? 'block' : 'none';
        }

        function highlightConnectedNodes(node) {
            // Reset all styling
            clearHighlights();

            // Highlight the selected node
            node.addClass('highlighted');

            // Highlight connected nodes and edges
            const connectedEdges = node.connectedEdges();
            const connectedNodes = connectedEdges.connectedNodes();

            connectedEdges.addClass('highlighted');
            connectedNodes.addClass('connected');

            // Dim non-connected elements
            cy.elements().not(node).not(connectedNodes).not(connectedEdges).addClass('dimmed');
        }

        function clearHighlights() {
            cy.elements().removeClass('highlighted connected dimmed');
        }

        function hideEntityDetails() {
            document.getElementById('entityDetailsCard').style.display = 'none';
        }

        function showTooltip(evt, node) {
            // Create or update tooltip
            let tooltip = document.getElementById('node-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'node-tooltip';
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }

            const nodeData = node.data();
            tooltip.innerHTML = `
                <strong>${nodeData.label || nodeData.name}</strong><br>
                <small>${nodeData.type}</small>
                ${nodeData.is_inferred ? '<br><small class="text-success">Inferred</small>' : ''}
            `;

            // Position tooltip
            const pos = node.renderedPosition();
            tooltip.style.left = (pos.x + 10) + 'px';
            tooltip.style.top = (pos.y - 10) + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('node-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        // Control functions
        function zoomIn() {
            cy.zoom(cy.zoom() * 1.2);
        }

        function zoomOut() {
            cy.zoom(cy.zoom() * 0.8);
        }

        function fitToScreen() {
            cy.fit();
        }

        function resetZoom() {
            cy.zoom(1);
            cy.center();
        }

        function centerGraph() {
            cy.center();
        }

        function performSemanticSearch() {
            const query = document.getElementById('searchBox').value.trim();
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            // Search in current graph first (client-side)
            searchInGraph(query);

            // Also perform server-side semantic search
            const url = `/editor/api/entities/search?query=${encodeURIComponent(query)}&ontology_id=${ontologyId}&limit=10`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySearchResults(data.results, query);
                    } else {
                        console.warn('Server search failed: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                });
        }

        function searchInGraph(query) {
            clearHighlights();

            const matchingNodes = cy.nodes().filter(node => {
                const data = node.data();
                const searchString = (data.label + ' ' + data.name + ' ' + (data.description || '')).toLowerCase();
                return searchString.includes(query.toLowerCase());
            });

            if (matchingNodes.length > 0) {
                // Highlight matching nodes
                matchingNodes.addClass('search-match');

                // Fit to matching nodes
                cy.fit(matchingNodes, 50);

                // Show details of first match
                showNodeDetails(matchingNodes[0]);
            } else {
                alert('No matching entities found in current view');
            }
        }

        function displaySearchResults(results, query) {
            const resultsPanel = document.getElementById('searchResultsPanel');
            const resultsContainer = document.getElementById('searchResults');

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="text-muted">No server results found</div>';
            } else {
                let html = '';
                results.forEach(result => {
                    html += `
                        <div class="search-result-item" onclick="highlightEntity('${result.uri}')">
                            <div class="fw-bold">${result.label || 'Unnamed'}</div>
                            <div class="small text-muted">${result.entity_type}</div>
                            ${result.comment ? `<div class="small">${result.comment.substring(0, 100)}...</div>` : ''}
                            <div class="similarity-score">Similarity: ${(result.similarity_score * 100).toFixed(1)}%</div>
                        </div>
                    `;
                });
                resultsContainer.innerHTML = html;
            }

            resultsPanel.style.display = 'block';
        }

        function highlightEntity(uri) {
            // Find and highlight entity in Cytoscape graph
            const targetNode = cy.nodes().filter(node => node.data('uri') === uri);

            if (targetNode.length > 0) {
                clearHighlights();
                targetNode.addClass('search-highlight');
                cy.animate({
                    center: { eles: targetNode },
                    zoom: 1.5
                }, {
                    duration: 500
                });
                showNodeDetails(targetNode[0]);
            } else {
                console.warn('Entity not found in current graph:', uri);
            }
        }

        function findSimilarEntities() {
            if (!currentEntityData || !currentEntityData.uri) {
                return;
            }

            const searchQuery = currentEntityData.name || currentEntityData.uri;
            document.getElementById('searchBox').value = searchQuery;
            performSemanticSearch();
        }

        function applyFilters() {
            const filterType = document.getElementById('filterType').value;
            const showInferred = document.getElementById('showInferred').checked;
            const showRestrictions = document.getElementById('showRestrictions').checked;

            if (!originalElements) {
                // If no data loaded yet, reload
                loadOntologyData();
                return;
            }

            // Filter elements based on criteria
            let filteredElements = [...originalElements];

            // Filter by entity type
            if (filterType !== 'all') {
                filteredElements = filteredElements.filter(element => {
                    if (element.group === 'edges') return true; // Keep all edges for now
                    return element.data.type === filterType;
                });

                // Remove edges where either source or target is filtered out
                const nodeIds = new Set(filteredElements.filter(e => e.group === 'nodes').map(e => e.data.id));
                filteredElements = filteredElements.filter(element => {
                    if (element.group === 'nodes') return true;
                    return nodeIds.has(element.data.source) && nodeIds.has(element.data.target);
                });
            }

            // Filter inferred relationships
            if (!showInferred) {
                filteredElements = filteredElements.filter(element => {
                    return !element.data.is_inferred;
                });
            }

            // Apply filters to graph
            cy.elements().remove();
            cy.add(filteredElements);

            // Update styling based on restrictions filter
            if (showRestrictions) {
                cy.nodes().forEach(node => {
                    if (node.data('restrictions') > 0) {
                        node.addClass('highlight-restrictions');
                    }
                });
            }

            // Re-apply layout
            applyLayout();
        }

        function updateStatistics(stats) {
            if (stats) {
                document.getElementById('totalNodes').textContent = cy ? cy.nodes().length : (stats.total_entities || 0);
                document.getElementById('totalEdges').textContent = cy ? cy.edges().length : 0;
                document.getElementById('classCount').textContent = stats.entity_type_counts?.class || 0;
                document.getElementById('propertyCount').textContent = stats.entity_type_counts?.property || 0;
                document.getElementById('inferredCount').textContent = stats.inferred_count || 0;
                document.getElementById('consistencyStatus').textContent = stats.consistency_check !== undefined ?
                    (stats.consistency_check ? 'Yes' : 'No') : 'Unknown';
            }
        }

        function exportVisualization() {
            if (!cy) {
                alert('No visualization loaded to export');
                return;
            }

            // Export as PNG
            const pngBlob = cy.png({
                output: 'blob',
                bg: '#ffffff',
                full: true,
                scale: 2 // High resolution
            });

            // Create download link
            const url = URL.createObjectURL(pngBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${ontologyId}_visualization.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>