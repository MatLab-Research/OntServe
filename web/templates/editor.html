{% extends "base.html" %}

{% block title %}Edit {{ ontology.name }} - OntServe{% endblock %}

{% block head %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<style>
    .CodeMirror {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        height: 600px;
        font-size: 14px;
    }

    .editor-toolbar {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-bottom: none;
        border-radius: 0.25rem 0.25rem 0 0;
        padding: 10px;
    }

    .version-panel {
        max-height: 400px;
        overflow-y: auto;
    }

    .entity-preview {
        max-height: 300px;
        overflow-y: auto;
    }

    .validation-message {
        font-size: 0.875rem;
    }

    .stats-badge {
        font-size: 0.875rem;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a
                        href="{{ url_for('ontology_detail', ontology_id=ontology.ontology_id) }}">{{ ontology.name
                        }}</a></li>
                <li class="breadcrumb-item active">Edit</li>
            </ol>
        </nav>

        <h1 class="mb-4">
            <i class="bi bi-pencil-square"></i> Edit Ontology
        </h1>
    </div>
</div>

<div class="row">
    <!-- Main Editor Column -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">{{ ontology.name }}</h5>
                        <small class="text-muted">{{ ontology.ontology_id }}</small>
                    </div>
                    <div>
                        <span class="stats-badge badge bg-secondary">
                            <i class="bi bi-diagram-3"></i> {{ ontology.triple_count or 0 }} triples
                        </span>
                        <span class="stats-badge badge bg-info">
                            <i class="bi bi-box"></i> {{ ontology.class_count or 0 }} classes
                        </span>
                        <span class="stats-badge badge bg-success">
                            <i class="bi bi-link-45deg"></i> {{ ontology.property_count or 0 }} properties
                        </span>
                    </div>
                </div>
            </div>

            <!-- Editor Toolbar -->
            <div class="editor-toolbar">
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-format">
                                <i class="bi bi-code-slash"></i> Format
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-validate">
                                <i class="bi bi-check-circle"></i> Validate
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-preview">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-save-draft">
                            <i class="bi bi-save"></i> Save Draft
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="btn-save-version">
                            <i class="bi bi-check2"></i> Save Version
                        </button>
                    </div>
                </div>
            </div>

            <!-- CodeMirror Editor -->
            <div class="card-body p-0">
                <textarea id="ontology-editor" name="content">{{ content }}</textarea>
            </div>

            <!-- Validation Messages -->
            <div id="validation-panel" class="card-footer" style="display: none;">
                <div id="validation-messages"></div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div class="col-md-4">
        <!-- Save Version Modal Form -->
        <div class="card mb-3" id="save-version-card" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">Save New Version</h6>
            </div>
            <div class="card-body">
                <form id="save-version-form">
                    <div class="mb-3">
                        <label for="commit-message" class="form-label">Commit Message</label>
                        <textarea class="form-control" id="commit-message" rows="3"
                            placeholder="Describe your changes..." required></textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check2"></i> Commit Changes
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-cancel-save">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Entity Preview -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Entity Preview</h6>
            </div>
            <div class="card-body entity-preview">
                <div id="entity-preview-content">
                    <p class="text-muted">Entity extraction will appear here after validation.</p>
                </div>
            </div>
        </div>

        <!-- Version History -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Version History</h6>
            </div>
            <div class="card-body version-panel">
                <div class="list-group list-group-flush">
                    {% for version in versions %}
                    <a href="#" class="list-group-item list-group-item-action version-item"
                        data-version-id="{{ version.id }}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">v{{ version.version_number }}</h6>
                            <small>{{ version.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <p class="mb-1">{{ version.commit_message or 'No message' }}</p>
                        <small class="text-muted">by {{ version.created_by or 'system' }}</small>
                    </a>
                    {% endfor %}

                    {% if not versions %}
                    <p class="text-muted">No version history yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version Diff Modal -->
<div class="modal fade" id="versionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Version Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="version-diff-content"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/turtle/turtle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">

<script>
    // Initialize CodeMirror
    var editor = CodeMirror.fromTextArea(document.getElementById('ontology-editor'), {
        mode: 'turtle',
        theme: 'default',
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {
            "Ctrl-/": "toggleComment",
            "Cmd-/": "toggleComment",
            "Ctrl-S": function (cm) { saveDraft(); },
            "Cmd-S": function (cm) { saveDraft(); }
        }
    });

    // Auto-save draft every 30 seconds
    let autoSaveInterval = setInterval(saveDraft, 30000);
    let lastSavedContent = editor.getValue();

    // Save draft function
    function saveDraft() {
        const content = editor.getValue();
        if (content === lastSavedContent) return;

        fetch('{{ url_for("save_draft", ontology_id=ontology.ontology_id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    lastSavedContent = content;
                    showNotification('Draft saved', 'success');
                }
            })
            .catch(error => {
                console.error('Error saving draft:', error);
            });
    }

    // Save version
    document.getElementById('btn-save-version').addEventListener('click', function () {
        document.getElementById('save-version-card').style.display = 'block';
    });

    document.getElementById('btn-cancel-save').addEventListener('click', function () {
        document.getElementById('save-version-card').style.display = 'none';
    });

    document.getElementById('save-version-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const content = editor.getValue();
        const commitMessage = document.getElementById('commit-message').value;

        fetch('{{ url_for("save_ontology", ontology_id=ontology.ontology_id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content,
                commit_message: commitMessage
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Version saved successfully', 'success');
                    document.getElementById('save-version-card').style.display = 'none';
                    document.getElementById('commit-message').value = '';
                    lastSavedContent = content;

                    // Reload version history
                    location.reload();
                } else {
                    showNotification('Error saving version: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error saving version', 'danger');
            });
    });

    // Validate ontology
    document.getElementById('btn-validate').addEventListener('click', function () {
        const content = editor.getValue();

        fetch('{{ url_for("validate_ontology") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        })
            .then(response => response.json())
            .then(data => {
                const panel = document.getElementById('validation-panel');
                const messages = document.getElementById('validation-messages');

                panel.style.display = 'block';

                if (data.valid) {
                    messages.innerHTML = `
                    <div class="alert alert-success validation-message mb-0">
                        <i class="bi bi-check-circle"></i> Ontology is valid!
                        <ul class="mb-0 mt-2">
                            <li>Triples: ${data.stats.triples}</li>
                            <li>Classes: ${data.stats.classes}</li>
                            <li>Properties: ${data.stats.properties}</li>
                        </ul>
                    </div>
                `;

                    // Update entity preview
                    if (data.entities) {
                        updateEntityPreview(data.entities);
                    }
                } else {
                    messages.innerHTML = `
                    <div class="alert alert-danger validation-message mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Validation errors:
                        <ul class="mb-0 mt-2">
                            ${data.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error validating ontology', 'danger');
            });
    });

    // Update entity preview
    function updateEntityPreview(entities) {
        const preview = document.getElementById('entity-preview-content');

        let html = '';

        if (entities.classes && entities.classes.length > 0) {
            html += `<h6>Classes (${entities.classes.length})</h6><ul class="small">`;
            entities.classes.slice(0, 5).forEach(cls => {
                html += `<li>${cls.label || cls.uri}</li>`;
            });
            if (entities.classes.length > 5) {
                html += `<li class="text-muted">... and ${entities.classes.length - 5} more</li>`;
            }
            html += '</ul>';
        }

        if (entities.properties && entities.properties.length > 0) {
            html += `<h6>Properties (${entities.properties.length})</h6><ul class="small">`;
            entities.properties.slice(0, 5).forEach(prop => {
                html += `<li>${prop.label || prop.uri}</li>`;
            });
            if (entities.properties.length > 5) {
                html += `<li class="text-muted">... and ${entities.properties.length - 5} more</li>`;
            }
            html += '</ul>';
        }

        preview.innerHTML = html || '<p class="text-muted">No entities found.</p>';
    }

    // Show notification
    function showNotification(message, type) {
        // You can implement a toast notification here
        console.log(`[${type}] ${message}`);
    }

    // Version history click
    document.querySelectorAll('.version-item').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            const versionId = this.dataset.versionId;

            // Load version content for comparison
            fetch(`{{ url_for("get_version", ontology_id=ontology.ontology_id) }}/${versionId}`)
                .then(response => response.json())
                .then(data => {
                    // Show diff in modal
                    const modal = new bootstrap.Modal(document.getElementById('versionModal'));
                    document.getElementById('version-diff-content').innerHTML = `
                        <pre>${data.content}</pre>
                    `;
                    modal.show();
                });
        });
    });
</script>
{% endblock %}